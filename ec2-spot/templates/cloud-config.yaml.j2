#cloud-config
package_update: true
packages:
  - jq
  - docker
  - git
  - awscli
  - amazon-cloudwatch-agent


write_files:
  - path: /etc/systemd/system/openclaw.service
    owner: root:root
    permissions: '0644'
    defer: true
    content: |
      {{ openclaw_service | indent(width=6) }}

  - path: /var/log/openclaw-s3-restore.log
    owner: root:root
    permissions: '0644'
    content: |
      

  - path: /var/log/openclaw-s3-backup.log
    owner: root:root
    permissions: '0644'
    content: |
      

  - path: /usr/local/bin/openclaw-s3-restore.sh
    owner: root:root
    permissions: '0755'
    defer: true
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      OPENCLAW_HOME="/opt/openclaw"
      BACKUP_BUCKET="{{ s3_backup_bucket_name }}"
      AWS_REGION="{{ aws_region }}"
      LOG_FILE="/var/log/openclaw-s3-restore.log"

      mkdir -p "$OPENCLAW_HOME/.openclaw"
      {
        echo "$(date -Iseconds) Starting restore from s3://$BACKUP_BUCKET"
        aws s3 sync "s3://$BACKUP_BUCKET/" "$OPENCLAW_HOME/.openclaw/" --region "$AWS_REGION" --delete
        chown -R ec2-user:ec2-user "$OPENCLAW_HOME/.openclaw"
        restored_files_count="$(find "$OPENCLAW_HOME/.openclaw" -mindepth 1 -type f | wc -l || true)"
        if [ "${restored_files_count:-0}" -eq 0 ]; then
          echo "$(date -Iseconds) Restore completed, but no files were found in s3://$BACKUP_BUCKET (bucket may be empty, e.g., on first deployment)"
        else
          echo "$(date -Iseconds) Restore complete; restored ${restored_files_count} file(s) from s3://$BACKUP_BUCKET"
        fi
        echo "$(date -Iseconds) Restore complete"
      } >> "$LOG_FILE" 2>&1

  - path: /usr/local/bin/openclaw-s3-backup.sh
    owner: root:root
    permissions: '0755'
    defer: true
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      OPENCLAW_HOME="/opt/openclaw"
      BACKUP_BUCKET="{{ s3_backup_bucket_name }}"
      AWS_REGION="{{ aws_region }}"
      LOG_FILE="/var/log/openclaw-s3-backup.log"

      if [ ! -d "$OPENCLAW_HOME/.openclaw" ]; then
        echo "$(date -Iseconds) ERROR: $OPENCLAW_HOME/.openclaw does not exist" >> "$LOG_FILE" 2>&1
        exit 1
      fi

      {
        echo "$(date -Iseconds) Starting backup to s3://$BACKUP_BUCKET"
        aws s3 sync "$OPENCLAW_HOME/.openclaw/" "s3://$BACKUP_BUCKET/" --region "$AWS_REGION"
        echo "$(date -Iseconds) Backup complete"
      } >> "$LOG_FILE" 2>&1

  - path: /etc/systemd/system/openclaw-s3-restore.service
    owner: root:root
    permissions: '0644'
    defer: true
    content: |
      [Unit]
      Description=OpenClaw restore from S3 backup
      After=network-online.target
      Wants=network-online.target
      Before=openclaw.service

      [Service]
      Type=oneshot
      User=root
      ExecStart=/usr/local/bin/openclaw-s3-restore.sh
      SyslogIdentifier=openclaw-s3-restore

      [Install]
      WantedBy=multi-user.target
      RemainAfterExit=yes

  - path: /etc/systemd/system/openclaw-s3-backup.service
    owner: root:root
    permissions: '0644'
    defer: true
    content: |
      [Unit]
      Description=OpenClaw backup to S3
      After=network-online.target openclaw-s3-restore.service
      Wants=network-online.target

      [Service]
      Type=oneshot
      User=root
      ExecStart=/usr/local/bin/openclaw-s3-backup.sh
      SyslogIdentifier=openclaw-s3-backup

      [Install]
      WantedBy=multi-user.target

  - path: /etc/systemd/system/openclaw-s3-backup.timer
    owner: root:root
    permissions: '0644'
    defer: true
    content: |
      [Unit]
      Description=Run OpenClaw S3 backup every 20 minutes
      Requires=openclaw-s3-backup.service

      [Timer]
      OnBootSec=5min
      OnUnitActiveSec=20min
      Persistent=true

      [Install]
      WantedBy=timers.target

  - path: /etc/systemd/system/openclaw-auto-approve.service
    owner: root:root
    permissions: '0644'
    defer: true
    content: |
      [Unit]
      Description=OpenClaw Device Pairing Auto-Approval
      After=openclaw.service
      Requires=openclaw.service docker.service
      
      [Service]
      Type=oneshot
      User=ec2-user
      ExecStart=/opt/openclaw/auto-approve-devices.sh /opt/openclaw
      SyslogIdentifier=openclaw-auto-approve
      
      [Install]
      WantedBy=multi-user.target

  - path: /etc/systemd/system/openclaw-auto-approve.timer
    owner: root:root
    permissions: '0644'
    defer: true
    content: |
      [Unit]
      Description=Run OpenClaw Device Pairing Auto-Approval Every Minute
      Requires=openclaw-auto-approve.service
      
      [Timer]
      OnBootSec=10s
      OnUnitActiveSec=1min
      Persistent=true
      
      [Install]
      WantedBy=timers.target

runcmd:
  - usermod -a -G docker ec2-user

  - |
    mkdir -p /usr/local/lib/docker/cli-plugins
    CUR_ARCH=$(uname -m)
    COMPOSE_URL="https://github.com/docker/compose/releases/download/{{ compose_version }}/docker-compose-linux-$CUR_ARCH"
    curl -sfL "$COMPOSE_URL" -o /usr/local/lib/docker/cli-plugins/docker-compose || { echo "Failed to download docker-compose from $COMPOSE_URL" >&2; exit 1; }
    chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

  - |
    OPENCLAW_HOME="/opt/openclaw"
    mkdir -p "$OPENCLAW_HOME/.openclaw/workspace"
    chmod 700 "$OPENCLAW_HOME/.openclaw"
    chmod 700 "$OPENCLAW_HOME/.openclaw/workspace"
    if [ ! -f "$OPENCLAW_HOME/.openclaw/openclaw.json" ]; then
    cat > "$OPENCLAW_HOME/.openclaw/openclaw.json" <<-EOF
    {
      "gateway": {
        "controlUi": {
          "allowedOrigins": [
            "http://localhost:18789",
            "http://127.0.0.1:18789"
          ]
        }
      }
    }
    EOF
    fi
    chown -R ec2-user:ec2-user "$OPENCLAW_HOME"

  - ln -sf /run/openclaw/.env /opt/openclaw/.env

  # Download bootstrap scripts from S3 (keeps cloud-config under 16KB limit)
  - |
    aws s3 cp "s3://{{ s3_scripts_bucket_name }}/auto-approve-devices.sh" /opt/openclaw/auto-approve-devices.sh || { echo "Failed to download auto-approve-devices.sh from s3://{{ s3_scripts_bucket_name }}/auto-approve-devices.sh" >&2; exit 1; }
    chmod 755 /opt/openclaw/auto-approve-devices.sh  
    chown ec2-user:ec2-user /opt/openclaw/auto-approve-devices.sh

  - |
    aws s3 cp "s3://{{ s3_scripts_bucket_name }}/cloudwatch-agent-config.json" /opt/aws/amazon-cloudwatch-agent/etc/config.json || { echo "Failed to download cloudwatch-agent-config.json from s3://{{ s3_scripts_bucket_name }}/cloudwatch-agent-config.json" >&2; exit 1; }  
    chmod 644 /opt/aws/amazon-cloudwatch-agent/etc/config.json

  - |
    aws s3 cp "s3://{{ s3_scripts_bucket_name }}/docker-compose.yaml" /opt/openclaw/docker-compose.yaml || { echo "Failed to download docker-compose.yaml from s3://{{ s3_scripts_bucket_name }}/docker-compose.yaml" >&2; exit 1; } 
    chmod 644 /opt/openclaw/docker-compose.yaml
    chown ec2-user:ec2-user /opt/openclaw/docker-compose.yaml

  - /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s -c file:/opt/aws/amazon-cloudwatch-agent/etc/config.json

  - systemctl enable docker.service
  - systemctl start docker.service

  - systemctl daemon-reload
  - systemctl enable openclaw-s3-backup.timer
  - systemctl start openclaw-s3-backup.timer
  - systemctl enable openclaw.service
  - systemctl start openclaw.service

  - systemctl enable openclaw-auto-approve.timer
  - systemctl start openclaw-auto-approve.timer
