#cloud-config
package_update: true
packages:
  - jq
  - docker
  - git
  - awscli
  - amazon-cloudwatch-agent

bootcmd:
  - |
    OPENCLAW_HOME="/opt/openclaw"
    OPENCLAW_DATA_DEVICE="{{ openclaw_data_device_name }}"
    ROOT_DEVICE=$(findmnt -n -o SOURCE / | sed 's/p[0-9]\+$//')

    mkdir -p "$OPENCLAW_HOME"

    if [ -b "$OPENCLAW_DATA_DEVICE" ]; then
      DATA_DEVICE="$OPENCLAW_DATA_DEVICE"
    else
      DATA_DEVICE=$(lsblk -pnro NAME,TYPE | awk '$2=="disk" {print $1}' | grep -v "$ROOT_DEVICE" | head -n1)
    fi

    if [ -n "$DATA_DEVICE" ] && [ -b "$DATA_DEVICE" ]; then
      if ! blkid "$DATA_DEVICE" >/dev/null 2>&1; then
        mkfs.ext4 -L OPENCLAW_DATA "$DATA_DEVICE"
      fi

      UUID=$(blkid -s UUID -o value "$DATA_DEVICE")
      if [ -n "$UUID" ] && ! grep -q "$UUID" /etc/fstab; then
        echo "UUID=$UUID $OPENCLAW_HOME ext4 defaults,nofail 0 2" >> /etc/fstab
      fi

      mountpoint -q "$OPENCLAW_HOME" || mount "$OPENCLAW_HOME"
    fi

# 1. Files to be created on the instance
write_files:
  - path: /opt/aws/amazon-cloudwatch-agent/etc/config.json
    owner: root:root
    permissions: '0644'
    content: |
      {{ cloudwatch_agent_config | indent(width=6) }}

  - path: /opt/openclaw/docker-compose.yaml
    owner: ec2-user:ec2-user
    permissions: '0644'
    defer: true
    content: |
      {{ docker_compose_config | indent(width=6) }}

  - path: /etc/systemd/system/openclaw.service
    owner: root:root
    permissions: '0644'
    defer: true
    content: |
      {{ openclaw_service | indent(width=6) }}

# 2. Commands to run after files are written
runcmd:
  - usermod -a -G docker ec2-user

  # Install Docker Compose Binary
  # We use the variables passed from Pulumi/Python
  - |
    mkdir -p /usr/local/lib/docker/cli-plugins
    CUR_ARCH=$(uname -m)
    COMPOSE_URL="https://github.com/docker/compose/releases/download/{{ compose_version }}/docker-compose-linux-$CUR_ARCH"
    curl -sfL "$COMPOSE_URL" -o /usr/local/lib/docker/cli-plugins/docker-compose || { echo "Failed to download docker-compose from $COMPOSE_URL" >&2; exit 1; }
    chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

  - |
    OPENCLAW_HOME="/opt/openclaw"
    mkdir -p "$OPENCLAW_HOME/.openclaw/workspace"
    chmod 700 "$OPENCLAW_HOME/.openclaw"
    chmod 700 "$OPENCLAW_HOME/.openclaw/workspace"
    echo '{}' > "$OPENCLAW_HOME/.openclaw/openclaw.json"
    chmod 600 "$OPENCLAW_HOME/.openclaw/openclaw.json"
    chown -R ec2-user:ec2-user "$OPENCLAW_HOME"

  - /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s -c file:/opt/aws/amazon-cloudwatch-agent/etc/config.json

  # Start Docker service
  - systemctl enable docker.service
  - systemctl start docker.service

  - systemctl daemon-reload
  - systemctl enable openclaw.service
  - systemctl start openclaw.service
