#cloud-config
package_update: true
packages:
  - jq
  - docker
  - git
  - awscli
  - amazon-cloudwatch-agent


write_files:
  - path: /etc/systemd/system/openclaw.service
    owner: root:root
    permissions: '0644'
    defer: true
    content: |
      {{ openclaw_service | indent(width=6) }}

  - path: /var/log/openclaw-s3-restore.log
    owner: root:root
    permissions: '0644'
    content: |
      

  - path: /var/log/openclaw-s3-backup.log
    owner: root:root
    permissions: '0644'
    content: |
      

  - path: /etc/systemd/system/openclaw-s3-restore.service
    owner: root:root
    permissions: '0644'
    defer: true
    content: |
      [Unit]
      Description=OpenClaw restore from S3 backup
      After=network-online.target
      Wants=network-online.target
      Before=openclaw.service

      [Service]
      Type=oneshot
      User=root
      ExecStart=/usr/local/bin/openclaw-s3-restore.sh {{ s3_backup_bucket_name }} {{ aws_region }}
      SyslogIdentifier=openclaw-s3-restore

      [Install]
      WantedBy=multi-user.target
      RemainAfterExit=yes

  - path: /etc/systemd/system/openclaw-s3-backup.service
    owner: root:root
    permissions: '0644'
    defer: true
    content: |
      [Unit]
      Description=OpenClaw backup to S3
      After=network-online.target openclaw-s3-restore.service openclaw.service
      Wants=network-online.target
      PartOf=openclaw.service
      # PartOf ensures backup only runs when OpenClaw service is active.
      # This provides basic consistency protection by preventing backups
      # while the service is stopped or restarting. For additional safety
      # in high-write scenarios, consider adding explicit file locks.

      [Service]
      Type=oneshot
      User=root
      ExecStart=/usr/local/bin/openclaw-s3-backup.sh {{ s3_backup_bucket_name }} {{ aws_region }}
      SyslogIdentifier=openclaw-s3-backup

      [Install]
      WantedBy=multi-user.target

  - path: /etc/systemd/system/openclaw-s3-backup.timer
    owner: root:root
    permissions: '0644'
    defer: true
    content: |
      [Unit]
      Description=Run OpenClaw S3 backup every 20 minutes
      Requires=openclaw-s3-backup.service

      [Timer]
      OnBootSec=5min
      OnUnitActiveSec=20min
      Persistent=true

      [Install]
      WantedBy=timers.target

  - path: /var/log/openclaw-s3-lifecycle.log
    owner: root:root
    permissions: '0644'
    content: |
      

  - path: /etc/systemd/system/openclaw-s3-lifecycle.service
    owner: root:root
    permissions: '0644'
    defer: true
    content: |
      [Unit]
      Description=OpenClaw S3 snapshot lifecycle management
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=oneshot
      User=root
      ExecStart=/usr/local/bin/openclaw-s3-lifecycle.py --bucket {{ s3_backup_bucket_name }} --region {{ aws_region }}
      StandardOutput=append:/var/log/openclaw-s3-lifecycle.log
      StandardError=append:/var/log/openclaw-s3-lifecycle.log
      SyslogIdentifier=openclaw-s3-lifecycle

      [Install]
      WantedBy=multi-user.target

  - path: /etc/systemd/system/openclaw-s3-lifecycle.timer
    owner: root:root
    permissions: '0644'
    defer: true
    content: |
      [Unit]
      Description=Run OpenClaw S3 snapshot lifecycle policy hourly
      Requires=openclaw-s3-lifecycle.service

      [Timer]
      OnBootSec=10min
      OnCalendar=hourly
      Persistent=true

      [Install]
      WantedBy=timers.target

  - path: /etc/systemd/system/openclaw-auto-approve.service
    owner: root:root
    permissions: '0644'
    defer: true
    content: |
      [Unit]
      Description=OpenClaw Device Pairing Auto-Approval
      After=openclaw.service
      Requires=openclaw.service docker.service
      
      [Service]
      Type=oneshot
      User=ec2-user
      ExecStart=/opt/openclaw/auto-approve-devices.sh /opt/openclaw
      SyslogIdentifier=openclaw-auto-approve
      
      [Install]
      WantedBy=multi-user.target

  - path: /etc/systemd/system/openclaw-auto-approve.timer
    owner: root:root
    permissions: '0644'
    defer: true
    content: |
      [Unit]
      Description=Run OpenClaw Device Pairing Auto-Approval Every Minute
      Requires=openclaw-auto-approve.service
      
      [Timer]
      OnBootSec=10s
      OnUnitActiveSec=1min
      Persistent=true
      
      [Install]
      WantedBy=timers.target

runcmd:
  - usermod -a -G docker ec2-user

  - |
    mkdir -p /usr/local/lib/docker/cli-plugins
    CUR_ARCH=$(uname -m)
    COMPOSE_URL="https://github.com/docker/compose/releases/download/{{ compose_version }}/docker-compose-linux-$CUR_ARCH"
    curl -sfL "$COMPOSE_URL" -o /usr/local/lib/docker/cli-plugins/docker-compose || { echo "Failed to download docker-compose from $COMPOSE_URL" >&2; exit 1; }
    chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

  - |
    OPENCLAW_HOME="/opt/openclaw"
    mkdir -p "$OPENCLAW_HOME/.openclaw/workspace"
    chmod 700 "$OPENCLAW_HOME/.openclaw"
    chmod 700 "$OPENCLAW_HOME/.openclaw/workspace"

  - ln -sf /run/openclaw/.env /opt/openclaw/.env

  # Download bootstrap scripts from S3 (keeps cloud-config under 16KB limit)
  - |
    aws s3 cp "s3://{{ s3_scripts_bucket_name }}/openclaw-s3-restore.sh" /usr/local/bin/openclaw-s3-restore.sh || { echo "Failed to download openclaw-s3-restore.sh from s3://{{ s3_scripts_bucket_name }}/openclaw-s3-restore.sh" >&2; exit 1; }
    chmod 755 /usr/local/bin/openclaw-s3-restore.sh

  - |
    aws s3 cp "s3://{{ s3_scripts_bucket_name }}/openclaw-s3-backup.sh" /usr/local/bin/openclaw-s3-backup.sh || { echo "Failed to download openclaw-s3-backup.sh from s3://{{ s3_scripts_bucket_name }}/openclaw-s3-backup.sh" >&2; exit 1; }
    chmod 755 /usr/local/bin/openclaw-s3-backup.sh

  - |
    aws s3 cp "s3://{{ s3_scripts_bucket_name }}/s3_snapshot_lifecycle.py" /usr/local/bin/openclaw-s3-lifecycle.py || { echo "Failed to download s3_snapshot_lifecycle.py from s3://{{ s3_scripts_bucket_name }}/s3_snapshot_lifecycle.py" >&2; exit 1; }
    chmod 755 /usr/local/bin/openclaw-s3-lifecycle.py

  - |
    aws s3 cp "s3://{{ s3_scripts_bucket_name }}/auto-approve-devices.sh" /opt/openclaw/auto-approve-devices.sh || { echo "Failed to download auto-approve-devices.sh from s3://{{ s3_scripts_bucket_name }}/auto-approve-devices.sh" >&2; exit 1; }
    chmod 755 /opt/openclaw/auto-approve-devices.sh  
    chown ec2-user:ec2-user /opt/openclaw/auto-approve-devices.sh

  - |
    aws s3 cp "s3://{{ s3_scripts_bucket_name }}/cloudwatch-agent-config.json" /opt/aws/amazon-cloudwatch-agent/etc/config.json || { echo "Failed to download cloudwatch-agent-config.json from s3://{{ s3_scripts_bucket_name }}/cloudwatch-agent-config.json" >&2; exit 1; }  
    chmod 644 /opt/aws/amazon-cloudwatch-agent/etc/config.json

  - |
    aws s3 cp "s3://{{ s3_scripts_bucket_name }}/docker-compose.yaml" /opt/openclaw/docker-compose.yaml || { echo "Failed to download docker-compose.yaml from s3://{{ s3_scripts_bucket_name }}/docker-compose.yaml" >&2; exit 1; } 
    chmod 644 /opt/openclaw/docker-compose.yaml
    chown ec2-user:ec2-user /opt/openclaw/docker-compose.yaml

  - /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s -c file:/opt/aws/amazon-cloudwatch-agent/etc/config.json

  - systemctl enable docker.service
  - systemctl start docker.service

  - systemctl daemon-reload
  - systemctl enable openclaw-s3-backup.timer
  - systemctl start openclaw-s3-backup.timer
  - systemctl enable openclaw-s3-lifecycle.timer
  - systemctl start openclaw-s3-lifecycle.timer
  - systemctl enable openclaw.service
  - systemctl start openclaw.service

  - systemctl enable openclaw-auto-approve.timer
  - systemctl start openclaw-auto-approve.timer
