[Unit]
Description=OpenClaw Docker Compose Service
Requires=docker.service
After=docker.service network-online.target openclaw-s3-restore.service
Wants=network-online.target

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/opt/openclaw
RuntimeDirectory=openclaw
RuntimeDirectoryMode=0700
ExecStartPre=/bin/sh -lc 'aws ecr get-login-password --region {{ aws_region }} | docker login --username AWS --password-stdin {{ ecr_registry_domain }}'
ExecStartPre=/bin/sh -lc "set -eu; TMP_ENV_FILE=$(mktemp /run/openclaw/.env.tmp.XXXXXX); aws ssm get-parameter --name '/openclaw-lab/dotenv' --with-decryption --region {{ aws_region }} --query 'Parameter.Value' --output text > \"$TMP_ENV_FILE\"; test -s \"$TMP_ENV_FILE\"; mv \"$TMP_ENV_FILE\" /run/openclaw/.env; chmod 640 /run/openclaw/.env; chgrp docker /run/openclaw/.env"
ExecStartPre=/usr/local/lib/docker/cli-plugins/docker-compose -f /opt/openclaw/docker-compose.yaml --env-file /run/openclaw/.env pull
ExecStart=/usr/local/lib/docker/cli-plugins/docker-compose -f /opt/openclaw/docker-compose.yaml --env-file /run/openclaw/.env up -d
ExecStop=/usr/local/lib/docker/cli-plugins/docker-compose -f /opt/openclaw/docker-compose.yaml --env-file /run/openclaw/.env down

User=ec2-user
Group=docker

[Install]
WantedBy=multi-user.target
